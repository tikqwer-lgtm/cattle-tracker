# Инструкция: Работа с данными вне программы

## Где хранятся данные?

Данные хранятся в **localStorage** браузера.

- Основной ключ: **`cattleEntries`** (режим без выбора объекта/базы или одна база).
- При использовании переключателя объектов (несколько баз) ключи имеют вид **`cattleEntries_<id>`** (например `cattleEntries_default`). Текущий выбранный объект хранится в `sessionStorage` и в настройках.

localStorage — встроенное хранилище браузера, данные сохраняются после закрытия вкладки.

## Как получить доступ к данным через консоль браузера?

### 1. Откройте консоль браузера
- Нажмите `F12` или `Ctrl+Shift+I` (Windows/Linux)
- Или `Cmd+Option+I` (Mac)
- Перейдите на вкладку "Console" (Консоль)

### 2. Просмотр данных

```javascript
// Получить все данные
const data = localStorage.getItem('cattleEntries');
console.log(data);

// Распарсить JSON
const entries = JSON.parse(localStorage.getItem('cattleEntries'));
console.log(entries);

// Посмотреть количество записей
const entries = JSON.parse(localStorage.getItem('cattleEntries') || '[]');
console.log('Всего записей:', entries.length);
```

### 3. Экспорт данных в файл

```javascript
// Скопировать данные в буфер обмена
const data = localStorage.getItem('cattleEntries');
navigator.clipboard.writeText(data);
console.log('Данные скопированы в буфер обмена!');

// Или создать файл для скачивания
const data = localStorage.getItem('cattleEntries');
const blob = new Blob([data], { type: 'application/json' });
const url = URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = 'cattle-data-backup.json';
a.click();
```

### 4. Импорт данных из файла

```javascript
// Если у вас есть JSON-строка в переменной jsonString:
const jsonString = '...'; // ваши данные
localStorage.setItem('cattleEntries', jsonString);
location.reload(); // перезагрузить страницу

// Или из файла (нужно использовать FileReader)
const input = document.createElement('input');
input.type = 'file';
input.accept = '.json';
input.onchange = (e) => {
  const file = e.target.files[0];
  const reader = new FileReader();
  reader.onload = (event) => {
    localStorage.setItem('cattleEntries', event.target.result);
    location.reload();
  };
  reader.readAsText(file);
};
input.click();
```

### 5. Очистка поврежденных данных вручную

```javascript
// Получить данные
let entries = JSON.parse(localStorage.getItem('cattleEntries') || '[]');

// Функция очистки строки
function cleanString(str) {
  if (!str || typeof str !== 'string') return str || '';
  return str.replace(/[\x00-\x1F\x7F-\x9F]/g, '').trim();
}

// Очистить все записи
const cleaned = entries.map(entry => {
  if (!entry || typeof entry !== 'object') return null;
  const cleaned = {};
  for (const key in entry) {
    if (typeof entry[key] === 'string') {
      cleaned[key] = cleanString(entry[key]);
    } else if (typeof entry[key] === 'object' && entry[key] !== null) {
      cleaned[key] = {};
      for (const subKey in entry[key]) {
        if (typeof entry[key][subKey] === 'string') {
          cleaned[key][subKey] = cleanString(entry[key][subKey]);
        } else {
          cleaned[key][subKey] = entry[key][subKey];
        }
      }
    } else {
      cleaned[key] = entry[key];
    }
  }
  return cleaned;
}).filter(entry => entry && entry.cattleId && entry.cattleId.trim().length > 0);

// Сохранить очищенные данные
localStorage.setItem('cattleEntries', JSON.stringify(cleaned));
console.log(`Очищено: было ${entries.length}, стало ${cleaned.length}`);

// Перезагрузить страницу
location.reload();
```

### 6. Полная очистка данных

```javascript
// Удалить все данные
localStorage.removeItem('cattleEntries');
location.reload();
```

### 7. Резервное копирование

```javascript
// Создать резервную копию с датой (для одной базы — ключ cattleEntries)
const data = localStorage.getItem('cattleEntries');
const backupKey = 'cattleEntries_backup_' + new Date().toISOString().split('T')[0];
localStorage.setItem(backupKey, data);
console.log('Резервная копия создана:', backupKey);

// Восстановить из резервной копии
const backupKey = 'cattleEntries_backup_2025-01-XX'; // замените на нужную дату
const backup = localStorage.getItem(backupKey);
if (backup) {
  localStorage.setItem('cattleEntries', backup);
  location.reload();
}
```

При нескольких объектах (базах) данные лежат под ключами `cattleEntries_<id>`; при необходимости сохраняйте или восстанавливайте нужный ключ.

## Где физически хранится localStorage?

### Chrome/Edge (Windows)
```
C:\Users\[USERNAME]\AppData\Local\Google\Chrome\User Data\Default\Local Storage\leveldb\
```

### Firefox (Windows)
```
C:\Users\[USERNAME]\AppData\Roaming\Mozilla\Firefox\Profiles\[PROFILE]\webappsstore.sqlite
```

### Важно!
- Не редактируйте файлы напрямую - это может повредить данные
- Используйте консоль браузера для работы с данными
- Всегда делайте резервную копию перед изменениями

## Проверка данных на повреждения

```javascript
// Проверить все записи на бинарные символы
const entries = JSON.parse(localStorage.getItem('cattleEntries') || '[]');
let damaged = 0;

entries.forEach((entry, i) => {
  for (const key in entry) {
    if (typeof entry[key] === 'string') {
      if (/[\x00-\x1F\x7F-\x9F]/.test(entry[key])) {
        console.warn(`Запись ${i}, поле ${key} содержит бинарные символы:`, entry[key]);
        damaged++;
      }
    }
  }
});

console.log(`Найдено поврежденных полей: ${damaged}`);
```
