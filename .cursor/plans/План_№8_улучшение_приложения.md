---
name: План №8 Улучшение приложения
overview: "План улучшений приложения: тосты сверху без наложения; нижняя граница не заплывает за панель задач; главное меню через подменю; действия «Запуск», «Отел», «Поставить на протокол»; настройки «Протоколы синхронизации»; сортировка в просмотре описи; раздел уведомлений «Список задач» (инъекции по протоколам, просмотр заранее); опционально корпоративный блок."
todos: []
isProject: false
---

# План №8 — Улучшение приложения

## 1. Всплывающие уведомления сверху с улучшенной видимостью

**Текущее состояние:** Тосты показываются в [css/base.css](css/base.css) (`.toast`: `position: fixed; bottom: 24px`) и создаются в [js/ui-helpers.js](js/ui-helpers.js) функцией `showToast()`. Каждый вызов создаёт новый элемент и вешает его в `body`; при нескольких сообщениях подряд тосты накладываются друг на друга. Вызовы разбросаны по [app.js](js/app.js), [backup.js](js/backup.js), [users.js](js/users.js), [export-import.js](js/export-import.js), [notifications.js](js/notifications.js).

**Решение (два изменения):**

1. **Перенос тостов сверху:** позиционировать тосты сверху экрана: в [css/base.css](css/base.css) и [electron/css/base.css](electron/css/base.css) заменить `bottom: 24px` на `top: 24px`, анимацию — с `translateY(100px)` на `translateY(-100px)` для появления сверху; для `.toast-visible` — `translateY(0)`. В [js/ui-helpers.js](js/ui-helpers.js) и [electron/js/ui-helpers.js](electron/js/ui-helpers.js) логику не менять (достаточно CSS).
2. **Улучшение видимости при нескольких сообщениях (без наложения):**
  - **Вариант A — очередь:** в `showToast()` вести очередь сообщений; показывать только один тост, после его скрытия (по таймауту) показывать следующий из очереди. Минус: при частых вызовах задержка перед показом.
  - **Вариант B — контейнер-стопка сверху:** завести один фиксированный контейнер (например `#toast-container`) вверху страницы; все тосты добавлять внутрь него и располагать по вертикали друг под другом (`display: flex; flex-direction: column; align-items: center; gap: 8px; top: 24px; left: 50%; transform: translateX(-50%);`). Каждый тост — отдельный блок; при появлении нового старые остаются выше/ниже с отступом, без наложения. Ограничить число видимых тостов (например 3–5) или максимальную высоту контейнера со скроллом.

Рекомендация: **Вариант B (стопка)** — все активные сообщения видны сразу, без наложения; при большом потоке можно ограничить количество или высоту. Реализация: в [index.html](index.html) и [electron/index.html](electron/index.html) добавить `<div id="toast-container" class="toast-container" aria-live="polite"></div>`, в `showToast()` вставлять тост в этот контейнер, в CSS задать стили контейнера и позиционирование тостов внутри него (сверху, по центру, с отступами между элементами).

---

## 2. Полноэкранный режим в десктопе: нижняя граница не должна заплывать за панель задач

**Проблема:** При развёртывании на весь экран **нижняя граница** приложения уходит под панель задач ОС (taskbar). Контент внизу оказывается скрыт или перекрыт.

**Текущее состояние:** Окно создаётся в [electron/main.js](electron/main.js) (`createWindow`: `BrowserWindow`). При максимизации или fullscreen окно занимает весь экран, и нижняя часть контента может попадать под панель задач.

**Решение:**

- Ограничить высоту окна или контента так, чтобы низ приложения не заходил под панель задач. Варианты:
  1. **Отступ снизу у контента:** в CSS для десктопной сборки задать у контейнера экранов (например `.screen` или `#app`) `padding-bottom` или `margin-bottom`, либо у основного скролл-контейнера — `padding-bottom: var(--taskbar-inset, 40px)`. Переменную `--taskbar-inset` передать из Electron (preload или main), ориентировочно 40–48 px в зависимости от ОС.
  2. **Окно не на весь экран по вертикали:** в [electron/main.js](electron/main.js) при максимизации использовать не полный экран, а `workArea` (например `screen.getDisplayNearestPoint(...).workArea`), чтобы окно не перекрывало панель задач. Либо после события `maximize` или при создании окна задавать `setBounds` с учётом `workArea.height` / `workArea.y`, чтобы нижняя граница окна совпадала с верхней границей панели задач.
  3. **Комбинированный подход:** в Electron при создании/максимизации окна получать `workArea` текущего дисплея и устанавливать размер/позицию окна в пределах workArea; дополнительно в CSS задать `padding-bottom` для страницы в десктопном режиме как подстраховку.

Итог: обеспечить, чтобы нижняя граница приложения не заплывала за панель задач (учёт workArea в Electron и/или отступ снизу в CSS).

---

## 3. Главное меню: группы сделать кнопками с переходом в подменю

**Текущее состояние:** На главном экране в [index.html](index.html) и [electron/index.html](electron/index.html) блок `.action-buttons` содержит несколько `.menu-section` с заголовком (например «Работа с данными», «Действия», «Аналитика», «Уведомления», «Настройки») и списком кнопок в `.menu-section-buttons`.

**Требование:** Вместо отображения всех кнопок сразу — показывать по одной кнопке на группу; по нажатию — переход на экран подменю с кнопками только этой группы.

**Реализация:**

1. **Новые экраны подменю** (один общий или по одному на группу):
  - Вариант: один экран `submenu-screen` с контейнером для заголовка и динамического набора кнопок (как сейчас `.menu-section-buttons`), кнопка «Назад» возвращает на `menu-screen`.
2. **Главный экран меню:** В каждой `.menu-section` оставить одну кнопку (карточку группы): например «Работа с данными» → по клику `navigate('submenu', { group: 'data' })` или аналог. Параметр группы передать через `sessionStorage`/глобальную переменную или через hash/query (если будет роутинг).
3. **Навигация:** В [js/menu.js](js/menu.js) расширить `navigate(screenId, options)` (или добавить вызов вида `navigateToSubmenu('data')`): при переходе на подменю записать текущую группу, отрендерить в контейнер подменю кнопки только этой группы (разметка кнопок может быть взята из текущего HTML или генерироваться из конфига).
4. **Конфиг групп:** Вынести соответствие «id группы → список кнопок (onclick, текст, иконка)» в JS (например в [menu.js](js/menu.js)), чтобы на главном экране рендерить по одной кнопке на группу, на экране подменю — список кнопок выбранной группы. Разметку в [index.html](index.html) и [electron/index.html](electron/index.html) заменить на одну общую структуру для главного меню (только кнопки-группы) и одну для подменю (заголовок + контейнер кнопок).

Дублировать логику и разметку в веб- и electron-версиях.

---

## 4. Кнопки в разделе «Действия»: Запуск, Отел, Поставить на протокол

**Текущее состояние:** В блоке «Действия» на главном меню только одна кнопка — «Ввести осеменение». В карточке животного ([view-cow.js](js/view-cow.js)) уже отображаются поля «Протокол» и «Начало протокола» ([storage-entries.js](js/storage-entries.js): `entry.protocol = { name, startDate }`). Справочник протоколов (название + этапы с днями и препаратами) пока не хранится — его нужно ввести в разделе «Протоколы синхронизации» (см. п. 7).

**Добавить в раздел «Действия»:**

- **«Запуск»** — запуск коровы в сухостой: форма выбора коровы и даты начала сухостоя (`dryStartDate`), сохранение через существующий слой обновления записи. Экран по аналогии с вводом осеменения (автокомплит по номеру коровы, поле даты).
- **«Отел»** — фиксация отёла: выбор коровы, ввод даты отёла (`calvingDate`), обновление записи (и при необходимости статуса/лактации). Экран с формой или диалог.
- **«Поставить на протокол»** (вместо «Поставить на схему»): начало протокола гормональной терапии. Имеется в виду назначение животному протокола с датой постановки; уколы по определённым дням рассчитываются от этой даты по правилам выбранного протокола (см. п. 7). При постановке на протокол у животного в карточке в поле «Протокол» указывается название протокола, в «Начало протокола» — дата постановки. Реализация: экран выбора коровы, выбор протокола из списка (справочник из «Протоколы синхронизации»), ввод даты постановки → сохранение `entry.protocol = { name: protocolName, startDate }`. Запланированные инъекции по этому протоколу затем отображаются в «Список задач» (п. 8).

---

## 5. Просмотр описи: сортировка по заголовкам столбцов

**Требование:** В экране «Список всех животных» (Просмотр описи) добавить возможность сортировать таблицу по любому столбцу по клику на заголовок.

**Текущее состояние:** Таблица строится в [js/view-list.js](js/view-list.js) (`updateViewList`), разметка — `<thead>` с `<th>` (Корова, Кличка, Группа, Лактация, Дата осеменения, Бык, Попытка, Статус, Отёл, Сухостой, Примечание, Синхронизация). Данные берутся из `getVisibleEntries(baseList)` / `getFilteredEntries()`.

**Реализация:**

- Сделать заголовки таблицы кликабельными (кнопки или `<th role="button">`). По клику: определить столбец, переключить направление сортировки (по возрастанию / убыванию) для этого столбца, пересортировать отображаемый массив записей и заново отрендерить таблицу. Хранить состояние сортировки (ключ столбца + направление) в переменной или в `data-*` на заголовке.
- Учесть тип данных: даты — сравнение по дате, числа — по числу, строки — по строке (локаль). Для столбца «Синхронизация» — сортировка по булеву значению.
- Визуально отмечать активный столбец сортировки и направление (например иконка ▲/▼ или класс на `<th>`). Стили в [css/components-tables.css](css/components-tables.css) / [electron/css/components-tables.css](electron/css/components-tables.css).

---

## 6. Настройки: «Протоколы синхронизации»

**Требование:** В разделе «Настройки» добавить пункт меню «Протоколы синхронизации» — экран для создания и редактирования протоколов (схем гормональной терапии). Эти протоколы используются при действии «Поставить на протокол» и для расчёта «Списка задач» (п. 8).

**Модель протокола:**

- Протокол — сущность с полями: **название** (уникальное отображаемое имя), **этапы (инъекции)** — список шагов, каждый шаг: **день** (номер дня от даты постановки на протокол, 0 = день постановки), **препарат** (название инъекции). Пример: «Синхрон-1», этапы: день 0 — «Гоновал», день 7 — «Сурфагон», день 9 — «Осеменение» и т.д.
- Хранение: отдельный ключ в localStorage (например `cattleTracker_protocols`) — массив объектов `{ id, name, steps: [{ day, drug }] }`. При работе с API — при необходимости отдельный endpoint или раздел в настройках объекта.

**Реализация:**

- В главном меню в группе «Настройки» добавить кнопку «Протоколы синхронизации» → переход на экран `protocols-screen`.
- Экран: список протоколов (название), кнопки «Добавить протокол», «Редактировать», «Удалить». Форма редактирования: название протокола + динамический список этапов (день + препарат), кнопки «Добавить этап», «Удалить этап». Сохранение в localStorage (и при наличии API — синхронизация по решению).
- Файлы: разметка в [index.html](index.html) / [electron/index.html](electron/index.html), логика и хранение — новый модуль `js/protocols.js` (и дубликат в `electron/js/protocols.js` при необходимости), подключение в [menu.js](js/menu.js) для навигации и отображения списка протоколов в форме «Поставить на протокол».

---

## 7. Раздел уведомлений: «Список задач» (запланированные инъекции по протоколам)

**Требование:** Дать пользователю возможность просматривать запланированные по протоколам инъекции. В разделе уведомлений добавить блок/экран «Список задач» с группировкой по датам и полями: **номер животного, группа**, инъекция (препарат из протокола), дата. Должна быть возможность формировать список задач **заранее** (например в понедельник смотреть задачи на пятницу).

**Логика данных:**

- Для каждой записи животного с заполненным `entry.protocol.name` и `entry.protocol.startDate` взять определение протокола из справочника (п. 6). По каждому этапу протокола (день + препарат) вычислить календарную дату инъекции: `startDate + day`. Собрать все такие события в общий список задач с полями: дата, номер коровы (cattleId), **группа (entry.group)**, препарат (название инъекции), при необходимости название протокола.
- Группировка отображения: по дате (заголовок даты, под ним строки: номер животного, группа, препарат, дата).

**Реализация:**

- В экране уведомлений ([notifications-screen](electron/index.html)) добавить секцию «Список задач» (например вкладка или блок под центром уведомлений). Либо отдельный экран `tasks-screen` с переходом из меню «Уведомления» / «Список задач».
- Элементы управления: **выбор периода дат** — например «Сегодня», «Завтра», «Неделя вперёд» или выбор начальной и конечной даты (date range). По выбранному периоду отфильтровать рассчитанные задачи и отобразить их с группировкой по датам. Формат строки в списке по дате: **номер животного | группа |** препарат (инъекция) **| дата**.
- Расчёт задач выполнять в JS: обход записей с `protocol.name` и `protocol.startDate`, получение шагов протокола из справочника, вычисление дат, фильтрация по выбранному диапазону, сортировка по дате. Отображение — в [js/notifications.js](js/notifications.js) или в новом модуле `js/tasks.js`, рендер в контейнер на экране уведомлений/задач.

---

## 8. Быстрые кнопки в карточке животного

**Требование:** В карточке животного ([view-cow.js](js/view-cow.js)) в блок «Действия» (`.cow-card-actions`) добавить быстрые кнопки: **«Запуск»**, **«Отел»**, **«Поставить на протокол»**. По нажатию вызывается тот же функционал, что и из главного меню (экраны «Запуск», «Отел», «Поставить на протокол»), с предзаполненной текущей коровой (cattleId открытой карточки), чтобы не вводить номер вручную.

**Реализация:** В разметку карточки в [view-cow.js](js/view-cow.js) добавить кнопки рядом с «Редактировать» и «Назад к списку»; по клику — вызов соответствующих обработчиков с передачей `cattleId` (например переход на экран «Запуск»/«Отел»/«Поставить на протокол» с установленным в форме номером коровы). Дублировать в [electron/js/view-cow.js](electron/js/view-cow.js).

---

## 9. Корпоративное «граффити» на главном экране

**Идея:** Разместить на главном экране (экран меню) корпоративный блок: логотип и название организации (аналог шапки для печати).

**Текущее состояние:** В [index.html](index.html) уже есть блок для печати `#print-header` с классом `.print-header` (МК «Генетика», логотип из `app-icons/icon.svg`). Его не показывают на экране (`aria-hidden="true"`, стили для печати).

**Реализация:**

- Добавить на экран меню (`#menu-screen`) отдельный блок, например `.menu-branding` или `.main-screen-branding`: логотип (тот же `app-icons/icon.svg` или отдельный файл) + текст «Молочная компания «Генетика»» (или краткий вариант). Разместить его вверху главного экрана, над или под заголовком «Меню», с нейтральными стилями (не перегружать экран).
- Стили в [css/layout.css](css/layout.css) / [css/style.css](css/style.css) и те же в `electron/`. При необходимости скрывать блок на узких экранах (медиа-запросы в [responsive.css](css/responsive.css)).

Это опциональный пункт; при согласии можно включить в план как последний шаг.

---

## Порядок работ и файлы


| #   | Задача                                                                    | Основные файлы                                                                                                                                                                                                           |
| --- | ------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 1   | Тосты: сверху + контейнер-стопка (без наложения)                          | [css/base.css](css/base.css), [electron/css/base.css](electron/css/base.css), [js/ui-helpers.js](js/ui-helpers.js), [index.html](index.html), [electron/index.html](electron/index.html)                                 |
| 2   | Нижняя граница не заплывает за панель задач                               | [electron/main.js](electron/main.js), [css/layout.css](css/layout.css), [electron/css/layout.css](electron/css/layout.css)                                                                                               |
| 3   | Главное меню → кнопки-группы и подменю                                    | [index.html](index.html), [electron/index.html](electron/index.html), [js/menu.js](js/menu.js)                                                                                                                           |
| 4   | Кнопки «Запуск», «Отел», «Поставить на протокол»                          | [index.html](index.html), [electron/index.html](electron/index.html), [cow-operations.js](js/cow-operations.js), [insemination.js](js/insemination.js), [storage.js](js/storage.js) / API, [view-cow.js](js/view-cow.js) |
| 5   | Сортировка в просмотре описи по заголовкам                                | [js/view-list.js](js/view-list.js), [css/components-tables.css](css/components-tables.css), [electron/css/components-tables.css](electron/css/components-tables.css)                                                     |
| 6   | Настройки: «Протоколы синхронизации»                                      | [index.html](index.html), [electron/index.html](electron/index.html), новый [js/protocols.js](js/protocols.js), [menu.js](js/menu.js)                                                                                    |
| 7   | Уведомления: «Список задач» (инъекции, группа в строке, просмотр заранее) | [index.html](index.html), [electron/index.html](electron/index.html), [js/notifications.js](js/notifications.js) или новый [js/tasks.js](js/tasks.js)                                                                    |
| 8   | Быстрые кнопки в карточке животного (Запуск, Отел, Поставить на протокол) | [js/view-cow.js](js/view-cow.js), [electron/js/view-cow.js](electron/js/view-cow.js)                                                                                                                                     |
| 9   | Корпоративный блок на главном экране (опционально)                        | [index.html](index.html), [electron/index.html](electron/index.html), [css/layout.css](css/layout.css), [electron/css/layout.css](electron/css/layout.css)                                                               |


Зависимости: пункты 6 (справочник протоколов) и 4 («Поставить на протокол») логически предшествуют п. 7 (Список задач); сортировка (5) и панель задач (2) можно делать параллельно с остальным.