---
name: Замер кода и разбивка
overview: Замер объёма кода по файлам проекта cattle-tracker и рекомендации, стоит ли разбивать крупные модули на более мелкие.
todos: []
isProject: false
---

# Замер кода и целесообразность разбивки

## Результаты замера (строки в файле)

### Electron — JavaScript ([electron/js/](electron/js/))


| Файл              | Строк   | Примечание                                  |
| ----------------- | ------- | ------------------------------------------- |
| **export.js**     | **734** | Самый большой модуль                        |
| **storage.js**    | **680** | Второй по размеру                           |
| menu.js           | 391     | Навигация + список + статистика + выделение |
| voice.js          | 312     | Голосовой ввод                              |
| search-filter.js  | 280     | Поиск и фильтры                             |
| insemination.js   | 260     | Осеменения                                  |
| users.js          | 263     | Многопользовательский режим                 |
| notifications.js  | 232     | Уведомления                                 |
| view-cow.js       | 208     | Карточка коровы                             |
| app.js            | 200     | Точка входа                                 |
| cow-operations.js | 196     | Операции с коровами                         |
| sync.js           | 193     | Синхронизация                               |
| backup.js         | 221     | Резервное копирование                       |
| analytics.js      | 220     | Аналитика                                   |
| ui-helpers.js     | 152     | Вспомогательные UI-функции                  |
| api-client.js     | 121     | API-клиент                                  |
| voice-handler.js  | 100     | Обработка голоса                            |
| events.js         | 51      | События                                     |
| core.js           | 49      | Ядро                                        |
| utils.js          | 13      | Утилиты                                     |


**Сумма по `electron/js/`:** ~5 500 строк.

### Electron — CSS ([electron/css/](electron/css/))


| Файл               | Строк   |
| ------------------ | ------- |
| **components.css** | **617** |
| view-cow.css       | 119     |
| base.css           | 79      |
| responsive.css     | 78      |
| forms.css          | 71      |
| layout.css         | 47      |
| sync.css           | 37      |
| style.css          | 9       |


### Electron — прочее

- [electron/index.html](electron/index.html) — **363** строки (вся разметка экранов в одном файле).
- [electron/main.js](electron/main.js) — 142 строки.
- [electron/preload.js](electron/preload.js) — 4 строки.

### Сервер ([server/](server/))

- db.js — 207  
- auth.js — 84  
- server.js — 40  
- routes/entries.js — 76  
- routes/auth.js — 48  
- scripts/init-db.js — 64  
- routes/objects.js — 18

Сервер уже разбит по маршрутам и ролям, размеры файлов приемлемые.

---

## Стоит ли разбивать код на более мелкие части?

**Да, разбивка имеет смысл** в первую очередь для четырёх модулей: они перегружены ответственностями и объёмом (600+ строк или один большой CSS).

### 1. storage.js (680 строк) — приоритет высокий

**Сейчас в одном файле:**

- работа с ключами и списком объектов (`getCurrentObjectId`, `setCurrentObjectId`, `getObjectsList`, `saveObjectsList`, `ensureObjectsAndMigration`, `switchToObject`, `addObject`);
- загрузка/сохранение записей (`loadLocally`, `saveLocally`, `getDefaultCowEntry`);
- очистка и валидация (`cleanEntry`, `cleanAllEntries`, `hasBinaryChars`, `checkDataIntegrity`, `forceCleanDamagedEntries`, `deleteAllData`);
- API-слой в конце файла (`loadObjectsFromApi`, `createEntryViaApi`, `updateEntryViaApi`, `deleteEntryViaApi`).

**Рекомендация:** выделить отдельные модули, например:

- `storage-keys.js` (или `storage-objects.js`) — объекты/базы, текущий объект, миграция;
- `storage-entries.js` — загрузка/сохранение записей, `entries`, работа с одной записью;
- `storage-integrity.js` — проверка целостности, очистка битых данных, `deleteAllData`;
- в `storage.js` оставить фасад: реэкспорт и минимум общей логики, чтобы не ломать существующие вызовы из `app.js`, `menu.js` и др.

### 2. export.js (734 строки) — приоритет высокий

**Сейчас в одном файле:**

- импорт JSON (через резервную копию);
- нормализация дат/статусов для импорта (`normalizeDateForStorage`, `normalizeStatusFromImport`, `separateCattleIdAndDate`);
- импорт CSV и Excel (`handleImportFile`, `decodeCsvFileContent`, `importFromCSV`, `importFromExcelWide`, `processImportData`);
- экспорт в Excel и шаблон (`exportToExcel`, `downloadTemplate`, `formatDateForExport`, `escapeCsvCell`, `getPDOForExport`).

**Рекомендация:** разбить на два модуля:

- `export-import.js` — весь импорт (CSV/Excel/JSON) + нормализация полей для импорта;
- `export-excel.js` (или `export-export.js`) — экспорт в Excel и скачивание шаблона.

Общие утилиты (`normalizeDateForStorage`, `escapeCsvCell` и т.п.) можно оставить в одном из этих файлов или вынести в `utils.js`, если начнут использоваться ещё где-то.

### 3. menu.js (391 строка) — приоритет средний

**Сейчас в одном файле:**

- навигация (`navigate`) и переключатель объектов (`updateObjectSwitcher`);
- список на экране «Просмотр» и массовое выделение (`updateViewList`, `_assertBulkSelectionUI`, `_handleViewListKeydown`, `_handleViewListClick`, `toggleRowSelection`, `selectAllEntries`, `deselectAllEntries`, `toggleSelectAll`, `updateSelectedCount`);
- статистика стада (`updateHerdStats`).

**Рекомендация:** вынести в отдельный модуль, например `view-list.js` (или `herd-list.js`): всё, что связано с `updateViewList` и выделением строк. В `menu.js` оставить навигацию, переключатель объектов и вызов `updateHerdStats` (или тоже вынести статистику в маленький `herd-stats.js` при желании).

### 4. components.css (617 строк) — приоритет средний

Один большой файл компонентных стилей. Имеет смысл разбить по блокам интерфейса, например:

- `components-buttons.css`, `components-forms.css`, `components-cards.css`, `components-tables.css` и т.д.,  
или по экранам: `components-view.css`, `components-menu.css`, если так проще поддерживать. Подключение всех частей оставить в `style.css` или в `index.html`.

### Что можно не трогать (пока)

- **index.html (363 строки)** — разбивать на фрагменты и подгружать через fetch/шаблоны имеет смысл только при переходе на SPA/фреймворк; для текущей структуры допустимо оставить одним файлом.
- **Файлы 200–312 строк** (app.js, voice.js, search-filter.js, insemination.js, users.js и др.) — размер приемлемый; разбивать стоит только если внутри появятся явно отдельные подсистемы или при следующем рефакторинге.
- **Сервер** — структура по файлам уже адекватная.

---

## Порядок работ при разбивке

1. **storage.js** — разделить на 3–4 модуля, сохранить обратную совместимость (глобальные функции/объекты, которые используют `app.js` и другие скрипты).
2. **export.js** — разделить на импорт и экспорт, проверить все вызовы из UI (кнопки импорта/экспорта).
3. **menu.js** — вынести логику списка и выделения в `view-list.js` (или аналог).
4. **components.css** — разбить на 2–4 файла по компонентам/экранам и обновить подключения стилей.

После каждого шага — проверить запуск приложения (Electron и веб), работу импорта/экспорта, переключения объектов и списка коров.

---

## Краткий вывод


| Модуль                 | Строк | Разбивать?       | Действие                                                 |
| ---------------------- | ----- | ---------------- | -------------------------------------------------------- |
| storage.js             | 680   | Да               | Выделить объекты/ключи, записи, целостность, API         |
| export.js              | 734   | Да               | Импорт и экспорт в отдельные файлы                       |
| menu.js                | 391   | Желательно       | Вынести список и выделение в отдельный модуль            |
| components.css         | 617   | Желательно       | Разбить по компонентам/экранам                           |
| Остальные JS (до ~312) | —     | По необходимости | Оставить как есть или дробить при следующем рефакторинге |
| index.html             | 363   | Опционально      | Оставить, если не переходите на SPA                      |


Имеет смысл проводить разбивку: она улучшит читаемость, тестируемость и дальнейшее изменение кода без риска затронуть несвязанную логику.