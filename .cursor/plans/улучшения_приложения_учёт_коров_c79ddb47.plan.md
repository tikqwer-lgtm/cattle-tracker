---
name: Улучшения приложения Учёт коров
overview: "План улучшений приложения «Учёт коров» по результатам анализа кодовой базы: архитектура и дублирование, UX и сообщения об ошибках, конфигурация и безопасность, тесты и качество кода, производительность и доступность."
todos: []
isProject: false
---

# План улучшений приложения «Учёт коров»

По результатам просмотра кода (корень `js/`, `electron/`, `server/`, [index.html](index.html), [README.md](README.md)) ниже — что можно улучшить и в каком порядке это имеет смысл делать.

---

## 1. Архитектура и дублирование кода

**Проблема:** Глобальная переменная `entries` объявлена в [js/storage/storage-objects.js](js/storage/storage-objects.js), дублируется в `window.entries`, а мутируется во многих файлах (storage.js, storage-entries.js, storage-integrity.js, sync.js и др.). Модули зависят друг от друга через проверки `typeof fn === 'function'` и глобальные имена — связность жёсткая, тестировать сложно.

**Рекомендации:**

- Ввести единую точку доступа к данным: фасад в [js/storage/storage.js](js/storage/storage.js) (или отдельный `data-store.js`), который хранит массив и экспортирует только функции `getEntries()`, `setEntries()`, `replaceEntries()`. Остальной код обращается к данным только через этот фасад.
- По возможности убрать дублирование логики между `js/` и `electron/js/`: сейчас [electron/copy-web.js](electron/copy-web.js) копирует весь веб-приложение в `electron/` перед сборкой; править нужно только файлы в `js/`, а в Electron использовать те же файлы (например, загружать из корня при разработке и при сборке копировать один раз). Тогда не будет расхождений, как в текущем git status (изменены и `js/features/*.js`, и `electron/js/features/*.js`).

---

## 2. UX: замена alert/confirm на тосты и модалки

**Проблема:** В проекте десятки вызовов `alert()` и `confirm()` ([js/core/app.js](js/core/app.js), [js/features/export-import.js](js/features/export-import.js), [js/features/backup.js](js/features/backup.js), [js/ui/cow-operations.js](js/ui/cow-operations.js), [js/features/view-list.js](js/features/view-list.js), [js/storage/storage-integrity.js](js/storage/storage-integrity.js) и др.). Блокирующие диалоги плохо сказываются на UX и доступности.

**Рекомендации:**

- Для информационных сообщений везде использовать уже существующий `showToast()` из [js/ui/ui-helpers.js](js/ui/ui-helpers.js).
- Для подтверждений (удаление, перезапись, смена сервера) ввести простой модальный диалог (один переиспользуемый компонент с кнопками «ОК»/«Отмена» и текстом), вызывать его вместо `confirm()`, и по результату выполнять действие. Так интерфейс останется единообразным и будет корректнее работать с screen readers.

---

## 3. Конфигурация и безопасность

**Проблема:** В [js/features/sync.js](js/features/sync.js) захардкожены:

- `DEFAULT_SERVER_URL = 'http://31.130.155.149:3000'`
- `GOOGLE_SCRIPT_URL` и `GOOGLE_SHEET_CSV_URL` (публичные URL Google Apps Script и таблицы)

Для развёртывания у разных пользователей и для безопасности адреса и ключи не должны быть в репозитории.

**Рекомендации:**

- Адрес сервера по умолчанию: либо убрать, либо брать из одного места конфигурации (например, `config.js`, не коммитить его с реальными URL) или из настроек приложения (как уже сделано для API в localStorage).
- URL Google Apps Script и таблицы: вынести в настройки в UI (например, экран «Синхронизация» / «Протоколы синхронизации») и хранить в localStorage по ключу вроде `cattleTracker_googleSyncConfig`. В коде оставить только чтение из этой настройки; в репозитории не хранить рабочие URL.

---

## 4. Синхронизация с Google и элемент «status»

**Проблема:** В [js/features/sync.js](js/features/sync.js) функции `saveToGoogle()` и `loadFromGoogle()` обращаются к `document.getElementById('status')` и меняют `textContent`. Элемент с id `status` может отсутствовать на текущем экране (например, пользователь на другом разделе), что приведёт к ошибке при вызове этих функций.

**Рекомендации:**

- Перед обращением к элементу проверять его наличие; если элемента нет — использовать `showToast()` для отображения статуса синхронизации и ошибок. Так сообщения будут видны независимо от экрана.

---

## 5. Тесты и качество кода

**Проблема:** В проекте нет тестов (нет Jest/Vitest, нет e2e). Нет конфигурации ESLint — стиль и простые ошибки не проверяются автоматически.

**Рекомендации:**

- Добавить ESLint с базовым набором правил (например, `eslint:recommended`) и при желании правила для браузера/ES5, чтобы ловить опечатки и типичные баги.
- Начать с модульных тестов для чистой логики без DOM: [js/features/search-filter.js](js/features/search-filter.js) (searchEntries, filterEntries, applySearchAndFilter), [js/features/analytics-calc.js](js/features/analytics-calc.js) — расчёты PR/CR/HDR. После рефакторинга хранилища (п.1) можно тестировать фасад хранилища.
- E2E (например, Playwright) — по желанию, для критичных сценариев: вход, добавление записи, просмотр списка, экспорт.

---

## 6. Производительность и загрузка

**Проблема:** В [index.html](index.html) подключается много отдельных скриптов; порядок загрузки жёстко задан. В [sw.js](sw.js) список кэшируемых файлов дублирует этот набор — при добавлении нового скрипта легко забыть обновить SW.

**Рекомендации:**

- Документировать в README или в комментарии в index.html правило: при добавлении/удалении скрипта обновлять и `sw.js` (и версию `CACHE_NAME` при релизе).
- Опционально: собрать один или несколько бандлов (Webpack/Vite/Rollup) для основных модулей, чтобы уменьшить число запросов и упростить порядок зависимостей; тогда в SW кэшировать уже бандлы. Это более крупное изменение, его можно отложить.

---

## 7. Доступность (a11y)

**Проблема:** Частично уже есть aria-атрибуты и роли (например, в [js/features/view-list.js](js/features/view-list.js) — `aria-label`, `role="button"`, `tabindex="0"`). В то же время массовое использование `alert()` блокирует фокус и плохо управляется скринридерами.

**Рекомендации:**

- После замены alert/confirm на тосты и модалки (п.2) убедиться, что модальное окно ловит фокус (focus trap), закрывается по Escape и возвращает фокус элементу, с которого открылось. У тостов уже есть `aria-live="polite"` у контейнера в [index.html](index.html) — оставить как есть.
- Проверить экран «Просмотр описи»: заголовки таблицы с сортировкой объявлены как `role="button"` — при активации с клавиатуры (Enter/Space) должна вызываться та же логика, что и по клику.

---

## 8. Серверная часть

**Наблюдение:** [server/server.js](server/server.js) и маршруты ([server/routes/entries.js](server/routes/entries.js), auth, objects) выглядят аккуратно: валидация, роли, централизованная обработка ошибок. Отдельно можно:

- Добавить лимит частоты запросов (rate limiting) для `/api/auth/login`, чтобы снизить риск перебора паролей.
- В ответах API при ошибках всегда возвращать единый формат (например, `{ error: string, code?: string }`), чтобы клиент в [js/api/api-client.js](js/api/api-client.js) стабильно показывал сообщения через тост.

---

## Приоритизация


| Приоритет | Что делать                                                                                                                                                                        |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Высокий   | П.3 — убрать захардкоженные URL из репозитория; П.4 — защита от отсутствия `#status` в sync.js.                                                                                   |
| Средний   | П.2 — замена alert/confirm на тосты и модалки; П.1 — один источник правды для `entries` и порядок правок только в `js/`.                                                          |
| Низкий    | П.5 — ESLint + несколько unit-тестов; П.6 — документирование SW и опционально бандлер; П.7 — доработка a11y модалок и клавиатуры; П.8 — rate limiting и единый формат ошибок API. |


Если нужно, могу расписать конкретные шаги по одному из пунктов (например, только по конфигурации sync или только по замене alert на тосты) в виде пошагового плана правок по файлам.