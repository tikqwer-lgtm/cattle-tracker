---
name: Таблица осеменений в карточке
overview: "Карточка животного: таблица осеменений по одной корове (кнопка «Все осеменения»). Экран «Все осеменения» из главного меню. Экспорт в .xlsx с двумя листами (Коровы + Осеменения). ВСП заменён на ПДО — расчёт: дней от отёла до первой даты осеменения. Модель: inseminationHistory."
todos: []
isProject: false
---

# Таблица всех осеменений в карточке животного

## Цель

В карточке животного ([js/view-cow.js](js/view-cow.js)) рядом с полем «Номер попытки» добавить кнопку «Все осеменения». По нажатию открывается отдельная таблица со списком всех осеменений по этой корове с колонками:

- Дата осеменения  
- Попытка  
- Бык  
- Осеменитель  
- Дней от предыдущего осеменения  
- Код осеменения

Сейчас в данных хранится только одно (последнее) осеменение на запись; при каждом новом вводе через «Ввести осеменение» старые данные перезаписываются ([js/insemination.js](js/insemination.js) — `addInseminationEntry`). Поэтому нужны изменения модели и логики сохранения.

---

## 1. Модель данных: история осеменений

**Файл:** [js/storage.js](js/storage.js)

- В `getDefaultCowEntry()` добавить поле:
  - `inseminationHistory: []` — массив объектов `{ date, attemptNumber, bull, inseminator, code }` (все строки, дата в том же формате, что и `inseminationDate`).

**Миграция старых записей:** в `loadLocally()` после парсинга `entries` для каждой записи:

- если есть `entry.inseminationDate` и (`!entry.inseminationHistory` или `entry.inseminationHistory.length === 0`), то один раз заполнить:
  - `entry.inseminationHistory = [{ date: entry.inseminationDate, attemptNumber: entry.attemptNumber ?? 1, bull: entry.bull ?? '', inseminator: entry.inseminator ?? '', code: entry.code ?? '' }]`.

Так у существующих коров «последнее» осеменение станет первым элементом истории.

---

## 2. Запись нового осеменения в историю

**Файл:** [js/insemination.js](js/insemination.js)

В `addInseminationEntry()` после нахождения `entry` и до присвоения полей:

- инициализировать массив: `if (!entry.inseminationHistory) entry.inseminationHistory = [];`
- добавить в историю новый объект: `entry.inseminationHistory.push({ date: inseminationDate, attemptNumber: ..., bull: ..., inseminator: ..., code: ... });`
- затем по текущей логике обновить «основные» поля записи (`entry.inseminationDate`, `entry.attemptNumber`, `entry.bull`, `entry.inseminator`, `entry.code`, `entry.status`).

В результате при каждом вводе осеменения история будет пополняться, а в карточке по-прежнему показывается последнее осеменение из этих полей.

---

## 3. Редактирование карточки и синхронизация последней записи в истории

**Файл:** [js/cow-operations.js](js/cow-operations.js)

При сохранении из формы редактирования (функция, которая пишет из формы в `entry`):

- после записи в `entry` полей `inseminationDate`, `attemptNumber`, `bull`, `inseminator`, `code` добавить:
  - если `entry.inseminationHistory && entry.inseminationHistory.length > 0`, обновить последний элемент истории так, чтобы он совпадал с текущими полями (дата, попытка, бык, осеменитель, код).  
  Так таблица «Все осеменения» и блок с последним осеменением на карточке останутся согласованными.

---

## 4. Карточка: кнопка и таблица

**Файл:** [js/view-cow.js](js/view-cow.js)

- В шаблоне карточки в блоке с «Номер попытки»:
  - оставить вывод текущего значения «Номер попытки»;
  - рядом добавить кнопку, например: «Все осеменения» (или «История осеменений»).
- Под блоком с полями (или рядом с этим рядом) добавить контейнер для таблицы (изначально скрытый), например `<div id="viewCowInseminationHistory" class="cow-insemination-history">...</div>`.

Логика данных для таблицы:

- Взять список: `entry.inseminationHistory` (если есть и не пустой), иначе, если есть `entry.inseminationDate`, сформировать один элемент из полей `entry.inseminationDate`, `entry.attemptNumber`, `entry.bull`, `entry.inseminator`, `entry.code`.
- Отсортировать по полю `date` по возрастанию (от старых к новым).
- Для каждой строки вычислить «Дней от предыдущего»: для первой строки — «—», для остальных — разница в днях между текущей датой и предыдущей в отсортированном списке.

Рендер:

- При построении карточки формировать HTML таблицы (заголовок: Дата осеменения | Попытка | Бык | Осеменитель | Дней от предыдущего | Код) и строк из полученного списка.
- Кнопка переключает видимость контейнера с таблицей (показать/скрыть). Один раз при открытии карточки таблица строится и вставляется в контейнер; переключение — только по классу/стилю (display или аналогично).

Экранирование: при выводе текста в ячейках использовать существующую функцию форматирования/экранирования (например `formatDate` для дат, для строк — аналог `escapeHtml` из [js/menu.js](js/menu.js)), чтобы избежать XSS.

---

## 5. Стили

**Файл:** [css/view-cow.css](css/view-cow.css)

- Стили для контейнера таблицы осеменений (например `.cow-insemination-history`): отступы, при необходимости скролл по горизонтали на узких экранах.
- Стили для таблицы: границы, выравнивание, заголовок (Дата осеменения, Попытка, Бык, Осеменитель, Дней от предыдущего, Код).
- Стили для кнопки «Все осеменения» (рядом с полем «Номер попытки»), чтобы визуально она была рядом и не ломала сетку.

---

## 6. Экран «Все осеменения» (доступ из главного меню)

**Цель:** просмотр списка всех осеменений по всем животным в одном месте.

**Разметка:** [index.html](index.html)

- Добавить новый экран (например `id="all-inseminations-screen"`), аналогично экрану просмотра описи: заголовок «Все осеменения», кнопка «Назад в меню», контейнер для таблицы.
- В блоке кнопок главного меню ([index.html](index.html) — `action-buttons`) добавить кнопку, например «Все осеменения» (или «Сводка осеменений»), с вызовом `navigate('all-inseminations')`.

**Логика и данные:** новый JS-модуль или функция в существующем (например в [js/view-cow.js](js/view-cow.js) или отдельный `js/all-inseminations.js`):

- Собрать по всем `entries` все осеменения: для каждой записи взять `entry.inseminationHistory` (если пусто — один элемент из полей `inseminationDate`, `attemptNumber`, `bull`, `inseminator`, `code`), каждую строку дополнить полями `cattleId` и при необходимости `nickname`.
- Получившийся плоский список отсортировать по дате осеменения (по возрастанию).
- Для колонки «Дней от предыдущего»: считать в контексте каждого животного (для первой осеменения по корове — «—», для следующих — разница в днях с предыдущей датой по этой же корове).
- Таблица: Номер коровы | Кличка | Дата осеменения | Попытка | Бык | Осеменитель | Дней от предыдущего | Код. При клике по строке (опционально) можно открывать карточку животного `viewCow(cattleId)`.

**Навигация:** в [js/menu.js](js/menu.js) в функции `navigate(screenId)` зарегистрировать экран `all-inseminations` (показ/скрытие по `screenId`). При показе этого экрана вызывать функцию построения таблицы (обновлять контент при каждом открытии).

**Стили:** общие стили таблиц из [css/components.css](css/components.css) или [css/view-cow.css](css/view-cow.css); при необходимости добавить класс для экрана «Все осеменения».

---

## 7. Экспорт в Excel: два листа

**Требование:** при экспорте выгружать один файл Excel с двумя листами: первый — текущая таблица коров (как сейчас), второй — таблица всех осеменений с полями и сортировкой по дате.

**Текущее состояние:** в [js/export.js](js/export.js) функция `exportToExcel()` формирует один CSV и отдаёт его как файл. CSV не поддерживает несколько листов, поэтому для двух листов нужен настоящий формат .xlsx.

**Реализация:**

- Подключить библиотеку для работы с .xlsx в браузере, например **SheetJS (xlsx)** — одна из распространённых, работает без сервера. Подключение через CDN в [index.html](index.html) (как уже сделано для PapaParse и Chart.js).
- В [js/export.js](js/export.js) переписать или дополнить `exportToExcel()`:
  - **Лист 1:** название например «Коровы» — те же колонки, что и в текущем CSV, но вместо «ВСП» — **ПДО** (см. раздел 9). Остальное: номер, кличка, дата рождения, лактация, дата отёла, дата осеменения, попытка, бык, осеменитель, код, статус, протокол, дата начала протокола, дата выбытия, сухостой, ПДО, примечание, синхронизация. Данные — массив `entries` по одной строке на запись.
  - **Лист 2:** название например «Осеменения» — колонки: Номер коровы, Кличка, Дата осеменения, Попытка, Бык, Осеменитель, Дней от предыдущего, Код. Данные: плоский список всех осеменений из всех записей (как в п. 6), отсортированный по дате осеменения по возрастанию. «Дней от предыдущего» — в контексте каждого животного (первое по корове — пусто или «—»).
- Скачивание: один файл .xlsx (имя например `коровы_YYYY-MM-DD.xlsx`).

**Обратная совместимость:** если нужна выдача CSV при отсутствии библиотеки — можно оставить запасной вариант (при отсутствии `XLSX` вызывать текущую логику CSV), но по умолчанию — .xlsx с двумя листами.

---

## 8. Синхронизация

- Без изменений: одна запись на животное, в ней поле `inseminationHistory` (сервер при необходимости может его игнорировать или сохранять).

---

## 9. ВСП → ПДО (расчётное поле)

**Требование:** поле должно называться не ВСП, а **ПДО** и рассчитываться как **количество дней от отёла до первой даты осеменения**.

- **Расчёт:** для каждой записи взять `entry.calvingDate` (дата отёла) и первую по времени дату осеменения: минимум по `entry.inseminationHistory[].date`, либо, если истории нет, `entry.inseminationDate`. ПДО = разница в днях между датой отёла и этой датой. Если отёла или первого осеменения нет — показывать «—» или пусто.
- **Где менять:**
  - [js/view-cow.js](js/view-cow.js) — в карточке: подпись «ВСП (дни)» заменить на «ПДО (дней от отёла до 1-го осеменения)», значение не из `entry.vwp`, а вычисленное по формуле выше.
  - [index.html](index.html) — в форме добавления/редактирования: поле «ВСП (дни)» заменить на отображение ПДО (только для чтения, расчётное) или убрать редактирование и показывать подпись «ПДО» с расчётом при наличии данных.
  - [js/cow-operations.js](js/cow-operations.js) — при сохранении формы не сохранять «vwp» в запись для ПДО (ПДО всегда считаем). Поле `entry.vwp` можно оставить в модели для обратной совместиости при импорте или удалить со временем.
  - [js/export.js](js/export.js) — в экспорте (CSV и лист «Коровы» в xlsx): колонку «ВСП» переименовать в «ПДО», значение выводить рассчитанное (дней от отёла до первого осеменения), а не `e.vwp`.
- **Импорт:** при импорте CSV колонку «ПДО» можно игнорировать (не перезаписывать запись), так как ПДО будет пересчитан; либо оставить старую колонку в шаблоне для совместимости, но в приложении везде показывать только расчётный ПДО.

---

## Порядок реализации

1. Добавить `inseminationHistory` в модель и миграцию в [js/storage.js](js/storage.js).
2. В [js/insemination.js](js/insemination.js) при добавлении осеменения дописывать объект в `inseminationHistory`.
3. В [js/cow-operations.js](js/cow-operations.js) при сохранении формы редактирования обновлять последний элемент `inseminationHistory`.
4. В [js/view-cow.js](js/view-cow.js) добавить кнопку, контейнер, построение таблицы по одной корове и переключение видимости.
5. В [css/view-cow.css](css/view-cow.css) добавить стили для кнопки и таблицы в карточке.
6. Добавить экран «Все осеменения»: разметка в [index.html](index.html), кнопка в меню, логика сбора и вывода таблицы по всем животным, навигация.
7. Подключить SheetJS (xlsx) в [index.html](index.html); в [js/export.js](js/export.js) реализовать экспорт в .xlsx с двумя листами («Коровы» и «Осеменения», второй лист — все осеменения с сортировкой по дате).
8. ВСП → ПДО: везде заменить отображение ВСП на расчётное поле ПДО (дней от отёла до первой даты осеменения): [js/view-cow.js](js/view-cow.js), форма в [index.html](index.html) / [js/cow-operations.js](js/cow-operations.js), экспорт в [js/export.js](js/export.js). Добавить вспомогательную функцию расчёта ПДО по записи (дата отёла + первая дата из `inseminationHistory` или `inseminationDate`).

