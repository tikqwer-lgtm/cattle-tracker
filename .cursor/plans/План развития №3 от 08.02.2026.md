---
name: План меню и объекты
overview: "План доработок: корректная статистика, поле «Группа», уведомления по типу, переключение объектов, группировка кнопок меню; фильтрация списка по полям описи; переименование «Просмотр описи» в «Список всех животных»."
todos:
  - id: todo-1770540544368-95mf8c54c
    content: ""
    status: pending
isProject: false
---

# План: меню, статистика, группы, объекты

## 1. Корректное отображение статистики на главном меню

**Проблема:** На скриншоте при 815 коровах и 780 осеменённых счётчики «Стельные», «В сухостое», «На брак» показывают 0 — подсчёт завязан на неверные подстроки в `status`.

**Текущая логика** в [js/menu.js](js/menu.js) (`updateHerdStats`, строки 256–260):

- Стельные: `e.status.includes('Отёл')`  
- В сухостое: `e.status.includes('Сухостой')`  
- Осеменённых: `e.inseminationDate`  
- На брак: `e.status.includes('брак')`

В форме в [index.html](index.html) (строки 208–215) варианты статуса: «Осемененная», «Холостая», **«Стельная»**, «Сухостой», «Отёл», «Брак». То есть:

- Для стельности нужно считать **«Стельная»** (и при необходимости «Отёл», если он означает ожидание отёла), а не только «Отёл».
- Для брака — **«Брак»** (учёт регистра: либо `toLowerCase().includes('брак')`, либо явно «Брак»).

**Что сделать:**

- В `updateHerdStats()` заменить подсчёт:
  - **Стельные:** `status` содержит «Стельная» (и при желании оставить или добавить «Отёл» по смыслу).
  - **На брак:** проверка по `status` с учётом «Брак» (например через `toLowerCase().includes('брак')` или точное совпадение опции).
- Убедиться, что список для статистики по-прежнему берётся через `getVisibleEntries(entries)` (уже так в коде).

После этого цифры «Стельные», «В сухостое», «На брак» будут соответствовать выбранным в форме статусам.

---

## 2. Поле «Группа» в карточке животного

**Цель:** Обозначение места размещения животного (группа) — одно новое поле в модели и во всех местах отображения/редактирования.

**Изменения:**

- **Модель:** [js/storage.js](js/storage.js) — в `getDefaultCowEntry()` добавить поле `group: ''`.
- **Карточка:** [js/view-cow.js](js/view-cow.js) — в разметку карточки (сетка `cow-details-grid`) добавить блок «Группа» с `escapeHtmlCard(entry.group)`.
- **Форма добавления/редактирования:** [index.html](index.html) — поле ввода «Группа» (например после «Кличка» или «Статус»); [js/cow-operations.js](js/cow-operations.js) — при сохранении читать значение и записывать в `entry.group`.
- **Список всех животных:** [js/menu.js](js/menu.js) — в таблицу `updateViewList()` добавить колонку «Группа».
- **Экспорт/импорт:** [js/export.js](js/export.js) — в экспорт (CSV/Excel) добавить колонку «Группа»; в импорте — читать и присваивать `entry.group`.
- **Миграция:** при загрузке старых записей без `group` считать `entry.group = entry.group || ''` (при необходимости в `loadLocally` или при первом чтении).

Фильтр по группе войдёт в общую фильтрацию по полям описи (см. п. 4).

---

## 3. Уведомления объединить по типу

**Текущее состояние:** В [js/notifications.js](js/notifications.js) `renderNotificationCenter` выводит плоский список последних 50 уведомлений без группировки.

**Цель:** Показывать уведомления сгруппированными **по типу** (категории: отёл, осеменение, сухостой, синхронизация, прочее).

**Что сделать:**

- Ввести категорию уведомления при создании (например `category: 'calving' | 'insemination' | 'dry' | 'sync' | 'other'`) в `createNotification` и сохранять в объекте уведомления.
- В `renderNotificationCenter` группировать `history` по полю категории/типа; рендерить блоки с заголовками групп («Предстоящий отёл», «Осеменение», «Сухостой», «Синхронизация», «Прочее») и списком уведомлений внутри каждой группы.
- Стили в CSS для заголовков групп и отступов (при необходимости новый класс в [css/style.css](css/style.css) или отдельный файл для уведомлений).

---

## 4. Фильтрация списка животных по полям описи

**Цель:** Возможность фильтровать список животных по полям, которые отображаются в таблице (описи).

**Текущее состояние:** В [js/search-filter.js](js/search-filter.js) уже есть поиск и фильтры (в т.ч. по статусу); экран списка строится в [js/menu.js](js/menu.js) (`updateViewList`). Таблица содержит колонки: Корова, Кличка, Лактация, Дата осеменения, Бык, Попытка, Статус, Отёл, Сухостой, Примечание, Синхронизация (и после внедрения п.2 — Группа).

**Что сделать:**

- Добавить фильтры по полям описи: по номеру/кличке (уже есть поиск), по статусу, по группе, по дате осеменения (диапазон или выбор), по дате отёла, по сухостою, по быку, по лактации и т.д. — в объёме, соответствующем колонкам таблицы.
- Разместить панель фильтров на экране «Список всех животных» (над таблицей или в свёрнутом блоке «Фильтры»): чекбоксы/селекты/поля дат по выбранным полям; кнопка «Сбросить фильтры».
- Использовать существующие функции в [js/search-filter.js](js/search-filter.js) (`getFilteredEntries`, фильтры по статусу и др.) и расширить их на новые поля (группа, даты, бык, лактация); при открытии экрана списка применять текущие фильтры к `baseList` и передавать результат в `getVisibleEntries` / отрисовку таблицы.
- Сохранение состояния фильтров в `localStorage` (как уже делается для части фильтров) — опционально, по желанию.

**Файлы:** [js/search-filter.js](js/search-filter.js), [js/menu.js](js/menu.js), [index.html](index.html) (экран просмотра — контейнер для панели фильтров), CSS для панели фильтров.

---

## 5. Переименовать «Просмотр описи» в «Список всех животных»

**Что сделать:**

- [index.html](index.html): текст кнопки в главном меню заменить с «Просмотр описи» на «Список всех животных».
- Заголовок экрана (h1 или заголовок блока на экране просмотра) заменить на «Список всех животных» (в [index.html](index.html) или там, где он задаётся).
- При необходимости обновить подпись в группе кнопок «Работа с данными» (см. п. 7) и любые другие упоминания «Просмотр описи» в интерфейсе (например в навигации «Назад к списку» можно оставить или заменить на «Назад в меню» по желанию).

---

## 6. Переключение между объектами работы (несколько баз)

**Цель:** Несколько независимых «объектов» (баз) с переключением между ними — каждая база свой набор `entries` и при необходимости свои настройки синхронизации.

**Текущее состояние:** Один ключ `cattleEntries` в localStorage, глобальный массив `entries` в [js/storage.js](js/storage.js).

**Подход:**

- **Хранение:** Для каждого объекта свой ключ, например `cattleEntries_${objectId}`. Список объектов хранить в отдельном ключе, например `cattleTracker_objects` — массив `{ id, name }`.
- **Текущий объект:** Выбранный `objectId` хранить в `localStorage` (например `cattleTracker_currentObject`) и при загрузке страницы подставлять в ключ для `entries`.
- **Загрузка/сохранение:** В [js/storage.js](js/storage.js) функции `loadLocally()` / `saveLocally()` (и везде, где читают/пишут `cattleEntries`) использовать ключ вида `cattleEntries_${getCurrentObjectId()}`. Переменная `entries` — данные текущего объекта; при смене объекта — перезагрузить `entries` из нового ключа, сохранить текущий объект в `localStorage`, обновить UI (меню, статистика, список).
- **UI:** На экране меню (например над статистикой или над кнопками) — селектор «Объект»: выпадающий список или кнопки с названиями объектов; кнопка «Добавить объект» (создать новую базу с пустым массивом); при выборе — переключить контекст и обновить экран.
- **Синхронизация и пользователи:** [js/sync.js](js/sync.js) и логика входа — при необходимости привязывать к текущему объекту (например отдельный ключ/настройки на объект) или оставить общий аккаунт с разными базами по объектам — уточнить по требованиям.

**Файлы:** [js/storage.js](js/storage.js), [index.html](index.html) (блок переключателя), [js/menu.js](js/menu.js) (обновление статистики и списка при смене объекта), при необходимости [js/app.js](js/app.js), [js/sync.js](js/sync.js).

---

## 7. Группировка кнопок в главном меню

**Цель:** Объединить кнопки по смыслу: Работа с данными, Действия, Аналитика, Уведомления (и при необходимости Настройки/Прочее).

**Текущее состояние:** В [index.html](index.html) все кнопки в одном блоке `action-buttons` (строки 79–131).

**Реализация:**

- Разбить кнопки на секции с заголовками (например `<div class="menu-section">` + `<h3 class="menu-section-title">Работа с данными</h3>` + обёртка кнопок).
- Предлагаемое разбиение:
  - **Работа с данными:** Добавить животное, Экспорт в Excel, Шаблон импорта, Импорт из Excel, Список всех животных, Все осеменения.
  - **Действия:** Ввести осеменение.
  - **Аналитика:** Аналитика.
  - **Уведомления:** Уведомления.
  - **Настройки / Прочее:** Войти / Пользователи, Резервные копии, Очистить повреждённые данные, Удалить все данные.
- Стили в [css/layout.css](css/layout.css) или [css/style.css](css/style.css): отступы между секциями, оформление заголовков секций, при необходимости адаптация под мобильные.

---

## Что ещё можно добавить в план

- **Фильтр по группе:** учтён в п. 4 (фильтрация по полям описи).
- **Резервные копии по объектам:** При включённых нескольких объектах — создание/восстановление резервной копии по выбранному объекту (или по всем), чтобы не смешивать базы.
- **Синхронизация по объектам:** Явная привязка облачной синхронизации к объекту (какой объект с каким «облаком»/аккаунтом связан) — если планируется разная синхронизация для разных хозяйств.
- **Экспорт/импорт с выбором объекта:** При экспорте — выбор «текущий объект» или «все объекты»; при импорте — в какой объект загружать.
- **Печать:** Кнопка «Печать» в карточке животного или печать списка описи (стили `@media print`).
- **Быстрые действия:** На главном экране блок «Недавно просмотренные» или «Избранные» номера коров для быстрого перехода в карточку.
- **Подсветка в уведомлениях:** В группе уведомлений выделять просроченные или требующие срочного действия (например по дате события в `meta`).

Если нужно, любой из пунктов «Что ещё» можно оформить отдельным подпунктом плана с конкретными шагами и файлами.
