---
name: Updates and DB sync
overview: Добавить автообновление приложения через GitHub Releases и обеспечить синхронизацию БД из одного источника (сервер) для нескольких пользователей с настраиваемым URL сервера в интерфейсе.
todos: []
isProject: false
---

# План: обновления через GitHub Releases и синхронизация БД из одного источника

## Текущее состояние

- **Сборка:** Electron с NSIS, версия в [electron/package.json](electron/package.json). Релизы в репозиторий не публикуются.
- **Данные:** Два режима — только localStorage или API ([js/api-client.js](js/api-client.js), [js/storage.js](js/storage.js)). Режим API включается только если в коде заданы `CATTLE_TRACKER_USE_API` и `CATTLE_TRACKER_API_BASE` (сейчас закомментировано в [index.html](index.html) строка 10).
- **Сервер:** [server/](server/) — Express, SQLite, auth + objects + entries. Уже реализует «один источник»: все клиенты с одним и тем же `CATTLE_TRACKER_API_BASE` работают с одной БД.

---

## Часть 1. Обновление приложения через GitHub Releases

### 1.1 Подключить electron-updater

- В [electron/package.json](electron/package.json) добавить зависимость `electron-updater` (из пакета `electron-builder` уже доступен через bundledDependencies; при необходимости добавить явно).
- В [electron/main.js](electron/main.js):
  - Импортировать `autoUpdater` из `electron-updater`.
  - Задать `autoUpdater.setFeedURL()` для GitHub: `{ provider: 'github', owner: 'tikqwer-lgtm', repo: 'cattle-tracker' }` (или через `publish` в конфиге сборки).
  - Вызывать `autoUpdater.checkForUpdates()` после `app.whenReady()` (при старте и/или по таймеру).
  - Обработчики: `update-available` — уведомить пользователя (диалог или системное уведомление); `update-downloaded` — предложить перезапуск и вызвать `autoUpdater.quitAndInstall()` при согласии.
  - В dev (`!app.isPackaged`) проверку не запускать.

### 1.2 Настройка публикации в electron-builder

- В [electron/package.json](electron/package.json) в секции `build` добавить `publish: { provider: 'github', owner: 'tikqwer-lgtm', repo: 'cattle-tracker' }` (или использовать переменные окружения).
- При сборке с публикацией: установить `GH_TOKEN` (или `GITHUB_TOKEN`) для загрузки артефактов в Releases. Для ручной загрузки релизов токен не обязателен в коде — только при автоматической публикации из CI.

### 1.3 Релизы на GitHub

- Версия приложения берётся из `electron/package.json` (`version`). Тег релиза на GitHub должен совпадать (например `v1.0.0`).
- Процесс: поднять версию → `npm run dist` в `electron/` → в репозитории создать Release с тегом `v1.0.0`, приложить установщик из `electron/dist/` (например `Учёт коров Setup 1.0.0.exe`). electron-updater по тегу и ассетам найдёт обновление.

### 1.4 Пункт «Проверить обновления» (обязательно)

- В приложении добавить явный способ ручной проверки обновлений:
  - Вариант A: пункт в системном меню окна Electron (Application Menu или контекстное меню), например «Справка → Проверить обновления».
  - Вариант B: кнопка/пункт в интерфейсе приложения (например в меню или на экране настроек/резервных копий).
- По нажатию вызывать `autoUpdater.checkForUpdates()` и показывать пользователю результат: «Обновлений нет» / «Доступна версия X.X.X. Скачивание…» / «Готово. Перезапустить?».

---

## Часть 2. Синхронизация БД из одного источника (несколько пользователей)

Архитектура уже есть: один сервер ([server/](server/)) — единый источник правды; все клиенты с одним URL работают с одной БД. Нужно дать пользователю возможность указать этот URL в приложении, не правя код.

### 2.1 Хранение URL сервера и включение режима API

- Ввести ключ localStorage, например `cattleTracker_apiBase` (и при желании `cattleTracker_useApi`).
- При загрузке приложения (до выполнения логики api-client):
  - Читать сохранённый URL из localStorage.
  - Если URL задан и не пустой: установить `window.CATTLE_TRACKER_USE_API = true` и `window.CATTLE_TRACKER_API_BASE = <url>`.
- Это нужно выполнять в самом начале, до подключения скриптов, которые проверяют `CATTLE_TRACKER_USE_API`. Варианты:
  - Небольшой инлайн-скрипт в [index.html](index.html) в `<head>`: читает `localStorage.getItem('cattleTracker_apiBase')`, при наличии задаёт `window.CATTLE_TRACKER_USE_API` и `window.CATTLE_TRACKER_API_BASE`.
  - Либо отдельный маленький скрипт, подключённый первым (до api-client.js), который только выставляет эти два флага из localStorage.

### 2.2 Экран/блок «Адрес сервера»

- На экране входа [index.html](index.html) (блок `#auth-screen`) добавить поле «Адрес сервера» (input), например над формой входа:
  - При первом запуске в режиме API можно показывать это поле обязательно; если URL уже сохранён — показывать его и давать изменить (например по кнопке «Изменить сервер»).
- Сохранять введённый URL в `localStorage` под выбранным ключом, нормализовать (убрать завершающий слэш), при сохранении выставлять `window.CATTLE_TRACKER_USE_API = true` и `window.CATTLE_TRACKER_API_BASE` и перезагружать страницу (или переинициализировать приложение), чтобы api-client и все модули работали уже с новым базовым URL.

### 2.3 Логика api-client

- [js/api-client.js](js/api-client.js) уже использует `global.CATTLE_TRACKER_API_BASE` и не обращается к localStorage. После пункта 2.1 при загрузке страницы эти переменные будут заданы из localStorage, менять api-client не требуется.
- При смене сервера в настройках достаточно обновить localStorage и перезагрузить окно (или перейти на экран входа с новым URL и перезагрузить), чтобы все последующие запросы шли на новый источник.

### 2.4 Развёртывание в интернете (обязательно HTTPS)

- Развёртывание предполагается в интернете: сервер должен быть доступен по **HTTPS** (не HTTP), иначе браузеры и Electron могут блокировать запросы к API из соображений безопасности.
- Рекомендуемая схема:
  - Сервер запускается на VPS/облаке (Node.js на порту 3000 или за обратным прокси).
  - Перед приложением — обратный прокси (Nginx, Caddy, облачный LB) с SSL: сертификат (Let's Encrypt или другой), проксирование на `http://localhost:3000`.
  - Пользователи в поле «Адрес сервера» вводят только **https://** URL (например `https://api.ваш-домен.ru` или `https://ваш-домен.ru/api`), без порта, если используется 443.
- В коде/интерфейсе: при сохранении URL можно проверять, что для не-localhost адресов используется `https://`, и показывать предупреждение при `http://` (опционально).

### 2.5 Документация для развёртывания «один источник — много пользователей»

- В [README.md](README.md) или в [server/README.md](server/README.md) добавить раздел про развёртывание в интернете:
  - Установить и запустить сервер на VPS/хостинге; настроить обратный прокси с HTTPS (Let's Encrypt).
  - На каждом клиенте один раз указать «Адрес сервера» — **https://** URL (например `https://api.example.com`).
  - После этого все клиенты синхронизированы через одну БД (один источник).
  - Для локальной сети допустим `http://IP:3000`; для доступа из интернета — только HTTPS.

---

## Порядок внедрения

1. **Синхронизация БД:** инлайн-скрипт в index.html для чтения URL из localStorage и установки флагов; поле «Адрес сервера» на экране входа и сохранение в localStorage; при необходимости перезагрузка после смены URL. Проверка: два окна/два устройства с одним URL видят одни и те же данные.
2. **Обновления:** подключить electron-updater в main.js, настроить feed (GitHub), обработчики update-available/update-downloaded; добавить `publish` в конфиг electron-builder; **добавить в приложение пункт/кнопку «Проверить обновления»**; описать в README создание релиза и загрузку установщика.

---

## Зависимости и риски

- **GitHub Releases:** для автоматической публикации из скрипта/CI нужен токен с правом на запись в репозиторий; при ручной загрузке релизов токен в коде не нужен.
- **Подписание кода (Windows):** без подписи установщика Windows может показывать предупреждение SmartScreen; на работу electron-updater это не влияет.
- **Сервер в интернете:** развёртывание в интернете предполагает обязательный HTTPS (обратный прокси + Let's Encrypt или другой сертификат). Без HTTPS современные окружения могут блокировать запросы к API. Локальная сеть: допустим HTTP и `http://IP:port` в «Адресе сервера».
