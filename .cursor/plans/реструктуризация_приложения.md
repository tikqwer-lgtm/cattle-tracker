---
name: Реструктуризация приложения
overview: "План реструктуризации: разбиение крупных JS- и CSS-файлов на модули, введение папок по доменам, плюс дополнительные шаги (константы, порядок скриптов, документация). Electron копирует корневые js/ и css/ как есть — менять нужно только корень репозитория."
todos: []
isProject: false
---

# Реструктуризация приложения cattle-tracker

## Текущее состояние

- **Клиент (корень):** плоская структура `js/` (27 файлов) и `css/` (стили уже частично разбиты через `@import` в [css/style.css](css/style.css) и [css/components.css](css/components.css)).
- **Крупные файлы (строки):**
  - JS: [js/export-import.js](js/export-import.js) 883, [js/view-list.js](js/view-list.js) 758, [js/analytics.js](js/analytics.js) 633, [js/view-cow.js](js/view-cow.js) 526, [js/cow-operations.js](js/cow-operations.js) 524, [js/notifications.js](js/notifications.js) 511, [js/menu.js](js/menu.js) 401, [js/sync.js](js/sync.js) 375.
  - CSS: [css/components-screens.css](css/components-screens.css) 693, [css/components-tables.css](css/components-tables.css) 344.
- **index.html:** ~702 строки, 19 экранов в одном файле; скрипты подключаются списком в конце ([index.html](index.html) строки 665–691).
- **Electron:** [electron/copy-web.js](electron/copy-web.js) рекурсивно копирует `js/`, `css/`, `index.html` из корня — после реструктуризации в корне сборка Electron подхватит новую структуру без правок (кроме путей в `index.html` при появлении подпапок).

---

## 1. Разбиение больших JS-файлов

Цель: файлы до ~300–400 строк, логические модули.


| Файл                                                                           | Действие                                                                                                                                                                                                                                                                                                |
| ------------------------------------------------------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **export-import.js** (883)                                                     | Вынести: (1) нормализацию дат/статусов и парсинг CSV/Excel в `export-import-parse.js`; (2) UI импорта (кнопки, шаги, отчёт) оставить в `export-import.js` или вынести в `export-import-ui.js`. В [index.html](index.html) добавить `<script src="js/export-import-parse.js">` перед `export-import.js`. |
| **view-list.js** (758)                                                         | Вынести: конфиг полей списка, шаблоны колонок и утилиты рендера в `view-list-fields.js`; виртуальный список и отрисовку таблицы оставить в `view-list.js`. Подключить `view-list-fields.js` перед `view-list.js`.                                                                                       |
| **analytics.js** (633)                                                         | Уже в IIFE. Вынести: расчёты PR/CR/HDR и сервис-периода в `analytics-calc.js`; отрисовку графиков и UI в `analytics.js`. Подключить `analytics-calc.js` перед `analytics.js`.                                                                                                                           |
| **view-cow.js** (526), **cow-operations.js** (524), **notifications.js** (511) | По желанию: при следующей итерации разбить (например, cow-operations на заполнение формы и сохранение/удаление). В первой фазе можно не трогать.                                                                                                                                                        |


Зависимости: глобальные `entries`, `getDefaultCowEntry`, `formatDate`, `showToast` и т.д. остаются; порядок скриптов в `index.html` нужно сохранять (сначала storage/core, потом модули, которые от них зависят).

---

## 2. Папки для JS (и при необходимости CSS)

Ввести доменные папки в корне (источник правды — корень; Electron копирует целиком).

**Вариант A — папки по слоям (рекомендуется для простоты путей):**

```
js/
  core/           — core.js, app.js, events.js, menu.js
  storage/        — storage.js, storage-objects.js, storage-entries.js, storage-integrity.js
  api/            — api-client.js
  features/       — insemination, view-cow, view-list, analytics, notifications, backup, protocols, sync, export-import, export-excel, search-filter, chat-consultant
  ui/             — ui-helpers.js, cow-operations.js, field-config.js
  utils/          — utils.js, voice-handler.js, voice.js
  users.js        — оставить в js/ или в core/
```

В [index.html](index.html) заменить пути, например: `js/storage/storage.js`, `js/features/analytics.js`. В скриптах друг друга вызывают по глобальным именам — пути к файлам не влияют.

**Вариант B — оставить плоский `js/**`, но разбить только большие файлы (меньше изменений, проще откат).

Выбор A даёт явную структуру и упрощает дальнейшее разбиение; B быстрее внедрить. В плане заложен вариант A; при откате к B папки не создаём, только дробим файлы.

---

## 3. Разбиение CSS

- **components-screens.css** (693): разбить по блокам в ту же папку или в подпапку `css/screens/`:
  - поиск/фильтр (`.search-filter-*`);
  - уведомления (`.notification-*`, `.menu-notifications-*`);
  - аналитика (экран аналитики);
  - модалка выбора полей (`.view-fields-modal-*`);
  - вход (`.auth-*`);
  - резервные копии и прочие экраны.
- В [css/components.css](css/components.css) заменить один `@import 'components-screens.css'` на несколько `@import 'screens/...'` (или оставить несколько `components-screens-*.css` в `css/` и импортировать их).
- **components-tables.css** (344): при желании разбить на таблицы списка и таблицы отчётов; можно отложить.

Пути в `@import` относительны от файла, в котором импорт (например, из `css/components.css` путь будет `screens/search-filter.css` при наличии `css/screens/search-filter.css`).

---

## 4. Что ещё включить в реструктуризацию

- **Единое место для констант:** создать `js/constants.js` (или `js/config.js`): ключи `localStorage` (`cattleTracker_*`), лимиты (например, число резервных копий), префиксы API. Подключить в начале блока скриптов. При желании часть констант оставить в модулях (как сейчас).
- **Убрать дублирование:** проверить `nowFormatted` в [js/app.js](js/app.js) и `formatDate`/даты в [js/utils.js](js/utils.js) — оставить одну реализацию даты/времени в `utils.js`, в `app.js` только вызывать.
- **Порядок скриптов в index.html:** явно сгруппировать комментариями (например: `<!-- core -->`, `<!-- storage -->`, `<!-- features -->`, `<!-- menu last -->`), чтобы при добавлении новых файлов порядок не ломался.
- **index.html:** экраны (19 блоков) оставить в одном файле; добавить короткие комментарии-разделители по секциям (Вход, Меню, Подменю, Формы, Просмотр, Настройки и т.д.) для навигации. Вынос экранов в отдельные HTML и подгрузка через fetch возможны позже (потребует инициализации после загрузки).
- **README:** после переноса файлов и папок обновить раздел «Структура проекта» в [README.md](README.md) под новое дерево `js/` и `css/`.

Опционально (не обязательно в этой реструктуризации):

- Введение сборки (например, esbuild) и ES-модулей — тогда порядок скриптов заменится на один entry и импорты; можно запланировать как следующий этап.
- Тесты после разбиения — чтобы рефакторинг не ломал логику.

---

## 5. Риски и ограничения

- **Глобальные переменные:** при разбиении нельзя разносить взаимозависимые функции по файлам с циклической загрузкой; порядок `<script>` остаётся критичным.
- **Electron:** при смене путей в `index.html` (например, `js/features/analytics.js`) копирование через [electron/copy-web.js](electron/copy-web.js) менять не нужно — копируются целиком `js/` и `css/`.
- **PWA/sw.js:** если в Service Worker захардкожены пути к скриптам для кэша — обновить список путей после переноса файлов.

---

## Рекомендуемый порядок работ

1. Добавить `js/constants.js` (при желании) и упорядочить комментарии скриптов в `index.html`.
2. Разбить 3 самых больших JS: `export-import.js`, `view-list.js`, `analytics.js` (новые файлы в том же `js/`).
3. Ввести папки в `js/` (core, storage, api, features, ui, utils) и перенести файлы; обновить все пути в `index.html`.
4. Разбить `components-screens.css` на 3–5 файлов в `css/screens/` и обновить `components.css`.
5. Убрать дублирование дат/времени (utils vs app).
6. Обновить README и при необходимости пути в `sw.js`.

После этого большие файлы будут разбиты, структура — по папкам, константы и порядок скриптов — приведены в порядок, документация обновлена.