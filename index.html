<script>
  const DATA_URL = 'https://tikqwer-lgtm.github.io/cattle-tracker/data.json';
  const DATA_FILE = 'data.json';

  let entries = [];

  async function loadFromGitHub() {
    try {
      const response = await fetch(DATA_URL + '?t=' + new Date().getTime());
      if (response.ok) {
        entries = await response.json();
      } else {
        entries = [];
      }
    } catch (error) {
      console.error('Не удалось загрузить данные:', error);
      entries = [];
    }
    updateList();
  }

  async function addEntry() {
    const cattleId = document.getElementById("cattleId").value.trim();
    const date = document.getElementById("date").value;
    if (!cattleId || !date) {
      alert("Заполните номер коровы и дату!");
      return;
    }

    const entry = {
      cattleId,
      date: formatDate(date),
      bull: document.getElementById("bull").value,
      attempt: document.getElementById("attempt").value || '',
      synchronization: document.getElementById("sync").value,
      note: document.getElementById("note").value,
    };

    entries.unshift(entry);
    updateList();
    clearForm();

    try {
      // Экспортируем в Excel
      exportToExcel();
      alert("✅ Запись добавлена! Excel-файл сохранён.");
    } catch (e) {
      alert("✅ Запись добавлена! (Excel не удалось сохранить)");
    }
  }

  function formatDate(dateStr) {
    const d = new Date(dateStr);
    return d.toLocaleDateString("ru-RU");
  }

  function updateList() {
    const list = document.getElementById("entriesList");
    list.innerHTML = `<div><strong>Всего записей: ${entries.length}</strong></div>`;
    if (entries.length === 0) {
      list.innerHTML += `<div style="color: #999; margin-top: 10px;">Нет данных</div>`;
    } else {
      entries.forEach((entry, i) => {
        const div = document.createElement("div");
        div.className = "entry";
        div.innerHTML = `
          <strong>Корова:</strong> ${entry.cattleId} | 
          <strong>Дата:</strong> ${entry.date}<br>
          <strong>Бык:</strong> ${entry.bull || '—'} | 
          <strong>Попытка:</strong> ${entry.attempt || '—'}<br>
          <em style="color: #666;">${entry.synchronization ? 'СИНХ: ' + entry.synchronization : ''} ${entry.note ? '• ' + entry.note : ''}</em>
        `;
        list.appendChild(div);
      });
    }
  }

  function clearForm() {
    document.getElementById("cattleId").value = "";
    document.getElementById("date").value = "";
    document.getElementById("bull").value = "";
    document.getElementById("attempt").value = "";
    document.getElementById("sync").value = "";
    document.getElementById("note").value = "";
  }

  function exportToExcel() {
    if (entries.length === 0) return;

    /* Создаём CSV */
    let csv = [
      ["Номер коровы", "Дата осеменения", "Бык", "Попытка", "Схема СИНХ", "Примечание"]
    ];

    entries.forEach(e => {
      csv.push([
        e.cattleId,
        e.date,
        e.bull,
        e.attempt,
        e.synchronization,
        e.note
      ]);
    });

    let csvContent = "data:text/csv;charset=utf-8," + 
      csv.map(row => row.map(cell => `"${cell}"`).join(";")).join("\n");

    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "Учёт_осеменения_коров.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  window.onload = loadFromGitHub;
</script>

